options:
  # Send logs only to CloudÂ Logging
  logging: CLOUD_LOGGING_ONLY

steps:
# Build the image
- name: 'gcr.io/cloud-builders/docker'
  id: BuildImage
  args:
    [
      'build',
      '--no-cache',
      '-t', 'gcr.io/$PROJECT_ID/pantrypal:$SHORT_SHA',
      '.'
    ]

# Run the Flask app and test functionality
- name: 'gcr.io/cloud-builders/docker'
  id: SmokeTest
  entrypoint: bash
  args:
    - -c
    - |
      set -e

      # launch your app in the background
      docker run -d --name smoke gcr.io/$PROJECT_ID/pantrypal:$SHORT_SHA

      echo "Waiting up to 10s for the app to start..."
      for i in $(seq 1 10); do
        if docker exec smoke curl --silent --fail http://localhost:8080/; then
          echo "Smoke test passed!"
          docker stop smoke
          exit 0
        fi
        echo "Retry #$i..."
        sleep 1
      done

      # on failure, show the app logs
      echo "Smoke test failed; dumping container logs:"
      docker logs smoke
      docker stop smoke
      exit 1