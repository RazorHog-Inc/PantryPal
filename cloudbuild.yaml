options:
  # Send logs only to Cloud Logging
  logging: CLOUD_LOGGING_ONLY

steps:
# Build the image
- name: 'gcr.io/cloud-builders/docker'
  args:
    [
      'build',
      '--no-cache',
      '-t', 'gcr.io/$PROJECT_ID/pantrypal:$SHORT_SHA',
      '.'
    ]

# Run the Flask app and test functionality
- name: 'gcr.io/cloud-builders/docker'
  id: 'SmokeTest'
  entrypoint: bash
  args:
    - -c
    - |
      docker run --rm -d --name smoke -p 8080:8080 \
        gcr.io/$PROJECT_ID/pantrypal:$SHORT_SHA
      until curl --retry 5 --retry-delay 1 --fail http://localhost:8080/; do
        echo "waiting…"; sleep 1
      done